# 函数调用约定

## 一、函数调用约定
##### `__cdecl`
调用者清理堆栈，参数右入栈。返回值在EAX中。

这种调用方式允许可变函数参数。

C/C++默认函数调用方式。

##### `__stdcall`
被调用者清理堆栈，参数右入栈。返回值在EAX中。

WIN32 API使用这个调用方式。

##### `__fastcall`
参数尽量采用寄存器传递。用ECX和EDX传送前两个双字（DWORD）或更小的参数，剩下的参数按照从右至左的方式入栈，函数自身清理堆栈，返回值在EAX中。

##### `__pascal`
与__stdcall相同。

##### `__thiscall`
C++特有的一种调用方式，用于类成员函数的调用约定。如果参数确定，this指针存放于ECX寄存器，函数自身清理堆栈；如果参数不确定，this指针在所有参数入栈后再入栈，调用者清理堆栈。参数按照从右至左的方式入栈。

## 二、编译器实现
i386栈的增长方向是从高地址向低地址增长。

每个函数使用一块独立的栈帧，EBP是帧指针（指向栈底），ESP指向栈顶（满栈栈顶）。

gcc默认采用__cdecl约定，因此参数从右向左依次压栈，然后调用函数。此时函数返回地址压栈，并切换进被调函数上下文。

被调用函数应当自己建立栈帧，首先ebp压栈，然后ebp赋值为esp的值，此时esp和ebp都指向栈帧保存点。函数返回时先恢复esp，再ebp出栈恢复主调函数的栈帧。

函数返回值默认情况下通过EAX传递。

栈指针ESP由调用者恢复，根据参数个数来调整。

原则上，参数全部通过栈传递，参数占据4字节（dword），未调整EBP时，取得第一个参数使用[esp+4]，第二个参数使用[esp+8]，以此类推；调整EBP后，取得第一个参数使用[esp+8]，第二个参数使用[esp+12]，以此类推。

- 函数定义
``` C
int f(int a, int b){
	int c = b;
	return a+c;
}
```

以上函数定义编译后的结果是：

``` ASM
_f:
	push ebp		;保存主调函数栈帧
	mov ebp, esp		;建立函数栈帧
	sub esp, 4		;建立局部变量c
	mov [ebp-4], [ebp+12]	;c=b
	mov eax, [ebp+8]	;eax=a
	add eax, [ebp-4]	;eax=a+c
	mov esp, ebp		;恢复esp
	pop ebp			;恢复主调函数栈帧
	ret			;return eax
```

- 函数调用
``` C
f(2,3);
```

以上函数调用编译后的结果是：

``` ASM
push 3		;第二个参数压栈
push 2		;第一个参数压栈
call _f		;函数调用
add esp, 8	;恢复栈
```

## 三、符号命名
C调用（`extern "C"`）使得编译器在符号表中函数名前加`_`。