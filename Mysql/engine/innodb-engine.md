# Innodb存储引擎

## ACID

##### 原子性 Atomicity
事务是一个不可分割的工作单位，事务中的操作要么都发生，要么都不发生。

##### 一致性 Consistency
事务前后数据的完整性必须保持一致。

##### 隔离性 Isolation
多个用户并发访问数据库时，数据库为每一个用户开启的事务，不能被其他事务的操作数据所干扰，多个并发事务之间要相互隔离。

##### 持久性 Durability
一个事务一旦被提交，它对数据库中数据的改变就是永久性的，接下来即使数据库发生故障也不应该对其有任何影响。

## 锁

##### 共享锁、排他锁

共享锁 shared (S) lock：读锁。允许其他事务加S锁，但不允许加X锁。

排他锁 exclusive (X) lock：写锁。不允许其他事务加S锁或X锁。

##### 意向锁  intention lock

意向锁是一个表级锁，用来表明事务之后申请的行级锁（共享锁、排他锁）意图。用于同时支持行级锁和表级锁。

共享意向锁（IS）：事务意图设置行共享锁。

排他意向锁（IX）：事务意图设置行排他锁。

事务申请行S锁前，必须首先申请IS锁或IX锁。事务申请行X锁前，必须首先申请IX锁。

例如`SELECT ... LOCK IN SHARE MODE`会设置IS锁，`SELECT ... FOR UPDATE`会设置IX锁。

<table>
    <tr><th></th><th>X</th><th>IX</th><th>S</th><th>IS</th></tr>
    <tr><tr><th>X</th><td>×</td><td>×</td><td>×</td><td>×</td></tr>
    <tr><th>IX</th><td>×</td><td>√</td><td>×</td><td>√</td></tr>
    <tr><th>S</th><td>×</td><td>×</td><td>√</td><td>√</td></tr>
    <tr><th>IS</th><td>×</td><td>√</td><td>√</td><td>√</td></tr>
</table>

##### 记录锁 record lock

记录锁是索引记录（index record）上的锁，不锁真正的数据记录。

例如`SELECT c FROM t WHERE c=10 FOR UPDATE`，对在c上的值为10的索引记录加锁。

##### 区间锁 gap lock

区间锁锁住一个索引记录范围，包括第一个索引记录前的区间和最后一个索引记录范围后的区间。区间都是开区间，包括端点。

例如`SELECT c FROM t WHERE c BETWEEN 10 and 20 FOR UPDATE`，对在c上的索引范围[10, 20]加锁（无论是否存在这样的索引记录）。

##### 临键锁 next-key lock

临键锁是对一个索引记录的记录锁，以及以其为右端点的区间锁。即对以该索引记录为右端点的左开右闭区间加锁。

##### 插入意向锁 insert intention lock

在插入的时候产生的一种区间锁，在多个事务同时写入不同数据至同一索引间隙的时候，并不需要等待其他事务完成，不会发生锁等待。

##### 自增锁 auto-inc lock

AUTO-INC锁是一种特殊的表级锁，发生涉及AUTO_INCREMENT列的事务性插入操作时产生。

## 隔离级别

隔离级引起的问题：
- 脏读：一个事务的查询结果是另一个事务还没有提交的更新数据。
- 非重复读：部分脏读。
- 幻读：连续相同的查询条件得到的结果不同。
- 更新丢失：一个事务的更新覆盖了另一个事务的更新。

| 隔离级别 | 脏读 | 不一致读 | 非重复读 | 幻读 | 更新丢失 |
|---|---|---|---|---|---|
| READ UNCOMMITTED | √ | √  | √  | √  | √  |
| READ COMMITTED |  |  | √  | √  | √  |
| REPEATABLE READ |  |  |  |  | √  |
| SERIALIZABLE |  |  |  |  |   |				

InnoDb的默认级别是REPEATABLE READ。

##### READ UNCOMMITTED 未提交读
会导致脏读。

修改数据时获取排它锁，修改后立即释放。

##### READ COMMITTED 提交读	
会导致幻读和非重复读。

读取数据获取共享锁，并在读取后立即释放；但修改数据获取排他锁，直到事务结束才释放。

无锁读时使用快照读，不加锁。

加锁读、更新、删除时，加记录锁，从而允许对其他记录的插入。区间锁只在外键约束检查与重复键检查时使用。

##### REPEATABLE READ 可重复读
事务读取的所有数据上设置共享锁，修改的所有数据上设置排它锁，锁直到事务结束才释放。该保证了在事务中多次读取相同的数据结果一致。

无锁读时使用快照读，不加锁。

加锁读、更新、删除时：
- 在唯一索引上的唯一查询条件，只对该索引加记录锁（不使用区间锁或临键锁）。
- 范围查询条件，对索引区间加锁（区间锁或临键锁），阻止范围内的记录插入。

##### SERIALIZABLE 可顺序化
将所有未加锁的SELECT语句都隐式转化为`SELECT ... LOCK IN SHARE MODE`。
