# TCP

Transmission Control Protocol

传输控制协议

TCP是一种面向连接的、可靠的、基于字节流的传输层协议，在RFC 793中定义。

TCP有以下特点：
- 面向连接。应用程序在使用TCP协议之前，必须先建立TCP连接；在传输数据完毕后，必须释放已经建立的连接。TCP连接只能是点对点的。
- 可靠。通过TCP连接传送的数据，无差错、不丢弃、不重复地按序到达。TCP使用停止等待协议来进行可靠传输。
- 基于字节流。TCP不负责分包，可能导致粘包。

每一条TCP连接由通信两端的两个套接字（IP地址和端口）确定。

## 一、TCP报文格式

TCP报文封装在IP数据报的数据部分。

<table>
	<tr>
		<th>位</th>
		<th colspan="16">16</th>
		<th colspan="16">16</th>
	</tr>
	<tr>
		<th>字段</th>
		<td colspan="16">源端口</td>
		<td colspan="16">目的端口</td>
	</tr>
	<tr>
		<th>位</th>
		<th colspan="32">32</th>
	</tr>
	<tr>
		<th>字段</th>
		<td colspan="32">序号（seq）</td>
	</tr>
	<tr>
		<th>位</th>
		<th colspan="32">32</th>
	</tr>
	<tr>
		<th>字段</th>
		<td colspan="32">确认号（ack）</td>
	</tr>
	<tr>
		<th>位</th>
		<th colspan="4">4</th>
		<th colspan="6">6</th>
		<th colspan="1">1</th>
		<th colspan="1">1</th>
		<th colspan="1">1</th>
		<th colspan="1">1</th>
		<th colspan="1">1</th>
		<th colspan="1">1</th>
		<th colspan="16">16</th>
	</tr>
	<tr>
		<th>字段</th>
		<td colspan="4">首部长度</td>
		<td colspan="6">0</td>
		<td colspan="1">URG</td>
		<td colspan="1">ACK</td>
		<td colspan="1">PSH</td>
		<td colspan="1">PST</td>
		<td colspan="1">SYN</td>
		<td colspan="1">FIN</td>
		<td colspan="16">窗口大小</td>
	</tr>
	<tr>
		<th>位</th>
		<th colspan="16">16</th>
		<th colspan="16">16</th>
	</tr>
	<tr>
		<th>字段</th>
		<td colspan="16">检验和</td>
		<td colspan="16">紧急指针</td>
	</tr>
	<tr>
		<th>位</th>
		<th colspan="32">可变</th>
	</tr>
	<tr>
		<th>字段</th>
		<td colspan="32">选项</td>
	</tr>
	<tr>
		<th>位</th>
		<th colspan="32">可变</th>
	</tr>
	<tr>
		<th>字段</th>
		<td colspan="32">数据部分</td>
	</tr>
</table>

##### 序号（seq）

TCP连接中传送的每一个字节都按顺序编号，该字段表示本报文段发送的数据第一个字节的序号。

##### 确认号（ack）

期望收到对方下一个报文段第一个数据字节的序号。

##### 首部长度	

单位为4字节。最小值为5，最大值为12。

##### URG	

URG=1时，表示紧急指针字段有效。

##### ACK	

ACK=1时，表示确认号字段有效，连接建立后传送的报文都必须把ACK置为1。

##### PSH	

PSH=1时，表示该报文应当尽快交付给应用进程。

##### RST	

RST=1时，表示（1）必须释放连接并重新建立，或（2）拒绝非法报文段，或（3）拒绝打开连接。

##### SYN	

连接建立时用来同步序号。当SYN=1，ACK=0时，表示连接请求；当SYN=1，ACK=1时，表示对连接请求的接受响应。

##### FIN	

FIN=1时，表示要求释放连接。

##### 窗口大小	

发送方的接收窗口大小。

##### 检验和	

在数据报之前添加12字节的伪首部，并计算整个报文。

TCP伪首部定义如下：

<table>
	<tr>
		<th>字节</th>
		<th>4</th>
		<th>4</th>
		<th>1</th>
		<th>1</th>
		<th>2</th>
	</tr>
	<tr>
		<th>字段</th>
		<td>源IP地址</td>
		<td>目的IP地址</td>
		<td>0</td>
		<td>6</td>
		<td>TCP长度</td>
	</tr>
</table>
		
##### 紧急指针	

仅在URG=1时有效，描述紧急数据的字节数。紧急数据位于数据部分的最前面。

##### 选项	

连续多个选项字段。

## 二、TCP选项

#### 选项表结束

<table>
	<tr>
		<th>字节</th>
		<th>1</th>
	</tr>
	<tr>
		<th>字段</th>
		<td>类型（0）</td>
	</tr>
</table>

#### 无操作
<table>
	<tr>
		<th>字节</th>
		<th>1</th>
	</tr>
	<tr>
		<th>字段</th>
		<td>类型（1）</td>
	</tr>
</table>

#### 最大报文段长度（MSS）
<table>
	<tr>
		<th>字节</th>
		<th>1</th>
		<th>1</th>
		<th>2</th>
	</tr>
	<tr>
		<th>字段</th>
		<td>类型（2）</td>
		<td>长度（4）</td>
		<td>最大报文段长度</td>
	</tr>
</table>

#### 窗口扩大因子
<table>
	<tr>
		<th>字节</th>
		<th>1</th>
		<th>1</th>
		<th>1</th>
	</tr>
	<tr>
		<th>字段</th>
		<td>类型（3）</td>
		<td>长度（3）</td>
		<td>移位数</td>
	</tr>
</table>

#### 时间戳
<table>
	<tr>
		<th>字节</th>
		<th>1</th>
		<th>1</th>
		<th>4</th>
		<th>4</th>
	</tr>
	<tr>
		<th>字段</th>
		<td>类型（8）</td>
		<td>长度（10）</td>
		<td>时间戳</td>
		<td>时间戳回显应答</td>
	</tr>
</table>

## 三、建立连接

TCP连接建立的过程中并未传输数据，因此seq只加1。

##### 初始序号（ISN）

TCP的报文序号占4个字节，序号标识每一个需要传输的数据字节。报文中的seq字段描述了当前报文数据第一个字节的序号。如果报文不包含数据，则报文本身占用一个序号。

TCP建立一个新的连接时，客户端和服务端需要分别随机生成各自初始序号。

##### TCP连接建立

第一个包：客户端向服务端发送SYN包，包括SYN和初始seq。客户端进入SYN-SEND状态，随后等待服务端的ACK包，如果未能收到服务端的ACK包，客户端需要超时重传SYN包。

第二个包：服务端收到SYN包后，向客户端回复ACK包，包括SYN、ACK、初始seq和ack，ack等于SYN包的seq+1。服务端进入SYN-RCVD状态，随后等待客户端的ACK包，如果未能收到客户端的ACK包，服务端需要超时重传ACK包。

第三个包：客户端收到ACK包后，向服务端回复ACK包，包括ACK、seq和ack，seq等于客户端初始seq+1，ack等于服务端初始seq+1，客户端ACK包也可以带上需要发送的初始数据。随后客户端进入ESTABLISHED状态，服务端收到客户端的ACK包后，也进入ESTABLISHED状态。客户端的ACK包不会超时重传。

![](1,jpg)

三次握手的目的在于，能使服务端再确认一次。客户端发出的SYN包可能在某个网络结点滞留，客户端因超时重传了该包后，滞留的SYN包又到达服务端，防止服务端认为其是一个新的连接请求。

在第三个包丢失的情况下，客户端单方面进入ESTABLISHED状态，服务端保持SYN-RCVD状态。服务端会周期性重传服务端ACK包，直到收到客户端的ACK包。

##### TCP连接同时建立

当主机A以端口x向主机B的端口y请求建立连接的同时，主机B以端口y向主机A的端口x请求建立连接，此时会导致TCP连接同时建立。

![](2.jpg)

四、释放连接
TCP连接释放

四次握手的目的在于连接允许半关闭。

主动关闭方最后要等待2MSL（报文段最大生存时间）后才关闭连接，保证这次连接的重复数据包从网络中消失。原因在于：
（一）如果Client直接CLOSED了，那么由于IP协议的不可靠性或者是其它网络原因，导致Server没有收到Client最后回复的ACK。那么Server就会在超时之后继续发送FIN，此时由于Client已经CLOSED了，就找不到与重发的FIN对应的连接，最后Server就会收到RST而不是ACK，Server就会以为是连接错误把问题报告给高层。这样的情况虽然不会造成数据丢失，但是却导致TCP协议不符合可靠连接的要求。所以，Client不是直接进入CLOSED，而是要保持TIME_WAIT，当再次收到FIN的时候，能够保证对方收到ACK，最后正确地关闭连接。
（二）如果Client直接CLOSED，然后又再向Server发起一个新连接，我们不能保证这个新连接与刚关闭的连接的端口号是不同的。也就是说有可能新连接和老连接的端口号是相同的。一般来说不会发生什么问题，但是还是有特殊情况出现：假设新连接和已经关闭的老连接端口号是一样的，如果前一次连接的某些数据仍然滞留在网络中，这些延迟数据在建立新连接之后才到达Server，由于新连接和老连接的端口号是一样的，又因为TCP协议判断不同连接的依据是socket pair，于是，TCP协议就认为那个延迟的数据是属于新连接的，这样就和真正的新连接的数据包发生混淆了。所以TCP连接还要在TIME_WAIT状态等待2倍MSL，这样可以保证本次连接的所有数据都从网络中消失。

TCP连接释放（同时关闭）

五、滑动窗口协议
滑动窗口协议是TCP使用的一种流量控制方法。该协议允许发送方在停止并等待确认前可以连续发送多个分组。由于发送方不必每发一个分组就停下来等待确认，因此该协议可以加速数据的传输。该协议要求发送的信息帧都有一个序号。

因为TCP是双工的，所以TCP连接的两端各自维护一个发送窗口和一个接收窗口。


发送窗口
发送端保持一个已发送但尚未确认的帧的序号表，称为发送窗口。
上界：要发送的下一个帧的序号。
下界：未得到确认的帧的最小编号。
发送窗口大小：上界与下界之差，大小可变。
发送端每发送一个帧，序号取上界值，上界加1。
发送端每接收到一个正确响应帧，下界加1。
接收窗口
上界：允许接收的序号最大的帧。
下界：希望接收的帧。
接收窗口容纳允许接收的信息帧，落在窗口外的帧均被丢弃。
序号等于下界的帧被正确接收，并产生一个响应帧，上界、下界都加1。接收窗口大小不变。
演示
六、慢启动
慢启动，是TCP使用的一种阻塞控制机制。发送方维护一个拥塞窗口（初始化为1），每收到一个确认就增加一个报文段。发送方发送报文的上限取拥塞窗口与发送窗口的最小值。初始时流量以指数增长，当达到阈值时，就进入线性增长。

七、TCP状态转换
