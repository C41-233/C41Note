# IP

Internet Protocol

网际协议

IP协议是TCP/IP协议族中的网络层协议，根据源主机和目的主机的地址来传送数据。IP协议将上层数据封装为数据报，IP协议仅尽力传输数据，对可靠性不作保证。

## 一、IP地址

Ip地址用于标识网络设备的地址。

---

### Ipv4

#### （1）分类

IPv4地址占32位，由网络号与主机号组成。通常以4组数字以点分十进制的方式标识，每组不超过255，例如`208.80.152.2`。

Ipv4地址可以分为A、B、C、D、E五大类。

##### A类地址

A类地址用于大量主机的大型网络。网络号占8位，第一位是0；主机号占24位，范围为`1.0.0.0`至`127.255.255.255`。

主机号全0表示网络地址，全1表示广播地址。

- 网络0.0.0.0表示本网络，只能用于源地址。
- 网络10.0.0.0表示专用地址。
- 网络127.0.0.0表示回环地址。

##### B类地址

B类地址用于中等规模主机数的网络。网络号占16位，前两位是10；主机号占16位。范围为`128.0.0.0`至`191.255.255.255`。

主机号全0表示网络地址，全1表示广播地址。

- 网络128.0.0.0不使用。
- 网络172.16.0.0至172.31.0.0表示专用地址。

##### C类地址

C类地址用于小型局域网。网络号占24位，前三位是110；主机号占8位。范围为`192.0.0.0`至`223.255.255.255`。

主机号全0表示网络地址，全1表示广播地址。

- 网络192.0.0.0不使用。
- 网络192.168.0.0至192.168.0.0表示专用地址。

##### D类地址

D类地址是多播地址，前四位是1110，其余28位是多播组ID。范围为``224.0.0.0`至`239.255.255.255`。

- 224.0.0.0表示基地址保留。
- 224.0.0.1表示在本地子网上的所有参加多播的主机和路由器，所有多播主机都加入该组，并且不需要发送IGMP报告报文。
- 224.0.0.2表示在本地子网上所有参加多播的路由器。
- 224.0.0.3未使用。
- 224.0.0.4表示DVMRP路由器。
- 224.0.0.0至224.0.0.255表示本地多播地址，路由器不会转发目的地址为本地多播地址的数据报。
- 224.0.1.0至238.255.255.255表示全球多播地址。
- 239.0.0.0至239.255.255.255表示组织内多播地址。

##### E类地址

E类地址是保留地址，仅用于实验和开发。前五位是11110。范围为`240.0.0.0`至`247.255.255.255`。

##### 特殊地址

255.255.255.255表示受限的广播地址，路由器不转发目的地址为受限广播地址的数据报，因此它只出现的本地网络中。RFC没有规定及多接口主机是否应当向其所有的接口发送受限的广播。

#### （2）子网掩码

子网掩码用于从IP地址中提取其对应的网络地址。子网掩码占32位，二进制位高位全为1，低位全为0，1对应IP地址中的网络号部分，0对应IP地址的主机号部分。IP地址与子网掩码按位与运算后，得到网络地址。子网掩码也以点分十进制的形式表示。

以下是所有可能的子网掩码：

| 网络位 | 主机位 | 子网掩码 |
|---|---|---|
| 0 | 32 | 0.0.0.0 |
| 1 | 31 | 128.0.0.0 |
| 2 | 30 | 192.0.0.0 |
| 3 | 29 | 224.0.0.0 |
| 4 | 28 | 240.0.0.0 |
| 5 | 27 | 248.0.0.0 |
| 6 | 26 | 252.0.0.0 |
| 7 | 25 | 254.0.0.0 |
| 8 | 24 | 255.0.0.0 |
| 9 | 23 | 255.128.0.0 |
| 10 | 22 | 255.192.0.0 |
| 11 | 21 | 255.224.0.0 |
| 12 | 20 | 255.240.0.0 |
| 13 | 19 | 255.248.0.0 |
| 14 | 18 | 255.252.0.0 |
| 15 | 17 | 255.254.0.0 |
| 16 | 16 | 255.255.0.0 |
| 17 | 15 | 255.255.128.0 |
| 18 | 14 | 255.255.192.0 |
| 19 | 13 | 255.255.224.0 |
| 20 | 12 | 255.255.240.0 |
| 21 | 11 | 255.255.248.0 |
| 22 | 10 | 255.255.252.0 |
| 23 | 9 | 255.255.254.0 |
| 24 | 8 | 255.255.255.0 |
| 25 | 7 | 255.255.255.128 |
| 26 | 6 | 255.255.255.192 |
| 27 | 5 | 255.255.255.224 |
| 28 | 4 | 255.255.255.240 |
| 29 | 3 | 255.255.255.248 |
| 30 | 2 | 255.255.255.252 |
| 31 | 1 | 255.255.255.254 |
| 32 | 0 | 255.255.255.255 |

---

### Ipv6

Ipv6地址占64位。

---

## 二、IP数据报

<table>
	<tr>
		<th colspan="1">位</th>
		<th colspan="4">4</th>
		<th colspan="4">4</th>
		<th colspan="3">3</th>
		<th colspan="1">1</th>
		<th colspan="1">1</th>
		<th colspan="1">1</th>
		<th colspan="1">1</th>
		<th colspan="1">1</th>
		<th colspan="16">16</th>
	</tr>
	<tr>
		<th colspan="1">字段</th>
		<td colspan="4">版本</td>
		<td colspan="4">首部长度</td>
		<td colspan="3">优先权</td>
		<td colspan="1">最小时延</td>
		<td colspan="1">最大吞吐量</td>
		<td colspan="1">最高可靠性</td>
		<td colspan="1">最小费用</td>
		<td colspan="1">0</td>
		<td colspan="16">总长度</td>
	</tr>
	<tr>
		<th colspan="1">位</th>
		<th colspan="16">16</th>
		<th colspan="1">1</th>
		<th colspan="1">1</th>
		<th colspan="1">1</th>
		<th colspan="13">13</th>
	</tr>
	<tr>
		<th colspan="1">字段</th>
		<td colspan="16">分片标识</td>
		<td colspan="1">MF</td>
		<td colspan="1">DF</td>
		<td colspan="1">0</td>
		<td colspan="13">片偏移</td>
	</tr>
	<tr>
		<th colspan="1">位</th>
		<th colspan="8">8</th>
		<th colspan="8">8</th>
		<th colspan="16">16</th>
	</tr>
	<tr>
		<th colspan="1">字段</th>
		<td colspan="8">TTL</td>
		<td colspan="8">协议</td>
		<td colspan="16">首部检验和</td>
	</tr>
	<tr>
		<th colspan="1">位</th>
		<th colspan="32">32</th>
	</tr>
	<tr>
		<th colspan="1">字段</th>
		<td colspan="32">源IP地址</td>
	</tr>
	<tr>
		<th colspan="1">位</th>
		<th colspan="32">32</th>
	</tr>
	<tr>
		<th colspan="1">字段</th>
		<td colspan="32">目的IP地址</td>
	</tr>
	<tr>
		<th colspan="1">位</th>
		<th colspan="32">0-40字节</th>
	</tr>
	<tr>
		<th colspan="1">字段</th>
		<td colspan="32">可选字段及填充位</td>
	</tr>
	<tr>
		<th colspan="1">位</th>
		<th colspan="32">不定长度</th>
	</tr>
	<tr>
		<th colspan="1">字段</th>
		<td colspan="32">数据部分</td>
	</tr>
</table>

##### 版本

标识IP协议的版本，IPv4为4。

##### 首部长度

标识IP数据报的首部长度，单位是4字节。没有任何可选字段时该值为5（20字节），最大值为15（60字节）。

##### TOS

用来获得更好的服务的标志位，包括最小时延、最大吞吐量、最高可靠性、最小费用。

##### 总长度

首部和未分片的所有数据的长度之和，单位是字节。

理论上IP数据报最大长度为65535字节，但通常受发送端和接收端TCP/IP内核或应用程序编程接口的限制。

##### 分片标识	

每产生一个数据报，该值加1。当数据报由于长度超过MTU而必须分片时，相同的标识字段值代表同一个数据报的不同IP分片。

##### MF	

1表示之后还有分片数据报，0表示当前是数据报分片中最后一个。

##### DF	

1表示该数据报不能分片，0表示该数据报可以分片。

##### 片偏移	

分片数据在原分组中的相对偏移，单位是8字节。

##### TTL	

生存时间，路由器在转发数据报之前将TTL减1。当TTL减少到0时，就丢弃该数据报，并向源端发送ICMP超时报文。如果当前主机是目的端，则不会丢弃报文和发送ICMP超时报文。

TTL还应该减去数据报在当前路由器停留的秒数，但很少有路由器这么实现。

##### 协议	

标识数据部分包含的上层协议。

| 协议字段 | 描述 |
|---|---|
| 1 | ICMP |
| 2 | IGMP |
| 6 | TCP |
| 8 | EGP |
| 9 | IGP |
| 17 | UDP |
| 41 | IPv6 |
| 89 | OSPF |

##### 首部检验和	

只检验数据报首部。

##### 可选	

用0填充至4字节的整数倍，最大为40字节。

## 三、可选字段

### RR选项

每个处理带有RR选项数据报的路由器把它的出口IP地址加入选项字段中。当数据报到达目的端时，IP地址列表复制到ICMP回显应答中，响应数据报也带有RR选项。这样发送端可以获得发送与返回路径的IP地址列表。

<table>
	<tr>
		<th>字节</th>
		<th>1</th>
		<th>1</th>
		<th>1</th>
		<th>0-36</th>
	</tr>
	<tr>
		<th>字段</th>
		<td>0x07</td>
		<td>长度</td>
		<td>偏移</td>
		<td>IP列表</td>
	</tr>
</table>
	
##### 长度	

选项的长度（单位为字节），通常设置为最大值39。

##### 偏移	

下一个插入的IP地址在选项中的字节偏移（从1开始），最小值为4。当偏移为40时，选项IP地址已满。

##### IP列表	

记录每一个IP地址，最多9个

---

### 时间戳选项

<table>
	<tr>
		<th>字节</th>
		<th>1</th>
		<th>1</th>
		<th>1</th>
		<th>1</th>
		<th>0-36</th>
	</tr>
	<tr>
		<th>字段</th>
		<td>0x44</td>
		<td>长度</td>
		<td>偏移</td>
		<td>OF FL</td>
		<td>（IP地址）时间戳列表</td>
	</tr>
</table>
	
##### 长度	

选项的长度（单位为字节）。

##### 偏移	

下一个插入的时间戳在选项中的偏移（从1开始），最小值为5。

##### OF	

溢出字段，如果选项已满而不能增加时间戳字段则设置该值，占4bit。

##### FL	

标志字段，占4bit。

- 0：只记录时间戳
- 1：每台路由器都记录IP地址和时间戳，每一项占8字节
- 3：发送端对选项列表进行初始化，存放4个IP地址和4个取指为0的时间戳。当列表中的下一个IP地址与当前路由器地址匹配时，才记录它的时间戳

##### （IP地址）时间戳列表	

记录每一个（IP地址）时间戳。

---

### 源站路由选项

源站路由过程如下:
1. 应用程序设定目的地址和源站路由列表。发送主机将列表中第一个IP地址去除，每个项左移，并将目的地址添加到列表最后。指针指向第一个IP地址（偏移值为4）。
2. 路由器收到数据报时，检查目的地址。如果当前路由器不是目的地址，且指针没有超出列表长度，那么在宽松的源站路由下，转发该数据报；在严格的源站路由下，返回源站路由失败ICMP报文。
3. 如果当前路由器是目的地址，那么（1）修改报文的目的地址为当前指针指向的地址，（2）当前指针指向的IP地址修改为当前路由器地址（出口地址），（3）指针后移（偏移量加4）。

<table>
	<tr>
		<th>字节</th>
		<th>1</th>
		<th>1</th>
		<th>1</th>
		<th>0-36</th>
	</tr>
	<tr>
		<th>字段</th>
		<td>0x83或0x89</td>
		<td>长度</td>
		<td>偏移</td>
		<td>IP列表</td>
	</tr>
</table>
	
0x83表示宽松的源站路由，0x89表示严格的源站路由。

##### 长度	

选项的长度（单位为字节）。

##### 偏移	

下一目的地址的字节偏移（从1开始）

##### IP列表	

记录每一个IP地址。

---

## 四、IP分片

物理链路层通常限制每次发送数据帧的最大长度，IP层根据MTU（Maximum Transmission Unit，最大传输单元）对数据报进行分片。把一份IP数据报分片后，只有到达目的地才会进行组装，组装由目的端IP层完成。以太网的MTU为1500字节，802.3的MTU为1492字节。

IP首部中通过分片标志来记录同一份数据报的不同分片。MF字段标识是否后续还有分片数据报。片偏移字段标识当前分组数据在整个数据报中的偏移。DF字段用于禁止分片，当路由器收到一份数据报并且需要分片，但设置了该标志后，则返回ICMP需要分片不可达报文。

IP层没有超时重传机制，即使只丢失一个分片，也要重传整个数据报。TCP协议在使用IP协议时，会试图避免分片。

在分片时，除最后一片外，其它每一片的数据部分长度必须是8字节的整数倍。

数据报的第一个分片到达时，IP层启动定时器，如果在规定时间内数据报未能全部到达，则丢弃已收到的数据报分片，并返回ICMP组装超时报文。很多系统并不返回这种ICMP报文，通常没有收到第一分片时无法获取IP数据前几个字节，因此也不返回ICMP报文。